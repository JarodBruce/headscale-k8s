apiVersion: v1
kind: Namespace
metadata:
  name: ${NAMESPACE}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: headscale-config
  namespace: ${NAMESPACE}
data:
  config.yaml: |
    server_url: ${HEADSCALE_SERVER_URL}
    listen_addr: ${HEADSCALE_LISTEN_ADDR}
    metrics_listen_addr: ${HEADSCALE_METRICS_LISTEN_ADDR}
    log:
      level: ${HEADSCALE_LOG_LEVEL}
    noise:
      private_key_path: ${HEADSCALE_NOISE_PRIVATE_KEY_PATH}
    database:
      type: ${HEADSCALE_DATABASE_TYPE}
      sqlite:
        path: /var/lib/headscale/db.sqlite
    prefixes:
      v4: ${HEADSCALE_PREFIX_V4}
      v6: ${HEADSCALE_PREFIX_V6}
      allocation: ${HEADSCALE_PREFIX_ALLOCATION_METHOD}
    derp:
      urls:
        - ${HEADSCALE_DERP_MAP_URL}
      auto_update_enabled: true
      update_frequency: ${HEADSCALE_DERP_UPDATE_FREQUENCY}
    dns:
      magic_dns: ${HEADSCALE_DNS_MAGICDNS}
      base_domain: ${HEADSCALE_DNS_BASE_DOMAIN}
      override_local_dns: true
      nameservers:
        global:
          - ${HEADSCALE_DNS_NAMESERVER_1}
          - ${HEADSCALE_DNS_NAMESERVER_2}
    policy:
      mode: file
      path: /etc/headscale-acl/acl.json
    preauth_keys:
      expiry: ${HEADSCALE_PREAUTH_KEY_EXPIRY_DAYS}d
    registration_method: ${HEADSCALE_REGISTRATION_METHOD}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: headscale-acl
  namespace: ${NAMESPACE}
data:
  acl.json: |
    {
      "groups": {
        "group:admins": ["${HEADSCALE_ACL_ADMIN_USER}"],
        "group:guests": ["${HEADSCALE_ACL_GUEST_USERS}"]
      },
      "acls": [
        {
          "action": "accept",
          "src": ["group:admins"],
          "dst": ["*:*"],
          "comment": "Admins have full mesh access"
        },
        {
          "action": "accept",
          "src": ["group:guests"],
          "dst": ["${HEADSCALE_ACL_GUEST_ALLOWED_DEST}"],
          "comment": "Guests have limited access to a single service"
        }
      ],
      "tagOwners": {
        "tag:admin": ["group:admins"]
      }
    }
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: headscale-data
  namespace: ${NAMESPACE}
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: headscale
  namespace: ${NAMESPACE}
  labels:
    app: headscale
spec:
  replicas: 1
  selector:
    matchLabels:
      app: headscale
  template:
    metadata:
      labels:
        app: headscale
    spec:
      containers:
        - name: headscale
          image: headscale/headscale:0.23.0
          args:
            - serve
            - --config
            - /etc/headscale/config.yaml
          ports:
            - name: grpc
              containerPort: 8080
            - name: metrics
              containerPort: 9090
          readinessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 20
          volumeMounts:
            - name: headscale-config
              mountPath: /etc/headscale
            - name: headscale-acl
              mountPath: /etc/headscale-acl
            - name: headscale-data
              mountPath: /var/lib/headscale
      volumes:
        - name: headscale-config
          configMap:
            name: headscale-config
        - name: headscale-acl
          configMap:
            name: headscale-acl
        - name: headscale-data
          persistentVolumeClaim:
            claimName: headscale-data
---
apiVersion: v1
kind: Service
metadata:
  name: headscale
  namespace: ${NAMESPACE}
  labels:
    app: headscale
spec:
  selector:
    app: headscale
  ports:
    - name: grpc
      port: 8080
      targetPort: 8080
    - name: metrics
      port: 9090
      targetPort: 9090

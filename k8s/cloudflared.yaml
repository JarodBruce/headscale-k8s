---
# Secret for Cloudflare API Token
apiVersion: v1
kind: Secret
metadata:
    name: cloudflare-api-token
    namespace: headscale
type: Opaque
stringData:
    token: "CLOUDFLARE_API_TOKEN_PLACEHOLDER"

---
# ServiceAccount for setup job
apiVersion: v1
kind: ServiceAccount
metadata:
    name: cloudflared-setup
    namespace: headscale

---
# Role for setup job
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
    name: cloudflared-setup
    namespace: headscale
rules:
    - apiGroups: [""]
      resources: ["secrets", "configmaps"]
      verbs: ["get", "list", "create", "update", "patch", "delete"]
    - apiGroups: ["apps"]
      resources: ["deployments"]
      verbs: ["get", "list", "patch"]

---
# RoleBinding for setup job
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
    name: cloudflared-setup
    namespace: headscale
subjects:
    - kind: ServiceAccount
      name: cloudflared-setup
      namespace: headscale
roleRef:
    kind: Role
    name: cloudflared-setup
    apiGroup: rbac.authorization.k8s.io

---
# ConfigMap for setup script
apiVersion: v1
kind: ConfigMap
metadata:
    name: cloudflared-setup-script
    namespace: headscale
data:
    setup-tunnel.sh: |
        #!/bin/sh
        set -e

        echo "==== Cloudflare Tunnel Automated Setup ===="
        echo "API Token: ${CLOUDFLARE_API_TOKEN:0:20}..."
        echo "Domain: ${HEADSCALE_DOMAIN}"
        echo "Account ID: ${CLOUDFLARE_ACCOUNT_ID:0:20}..."

        # Install required tools
        apk add --no-cache curl jq

        # Verify API Token
        echo ""
        echo "Step 1: Verifying API Token..."
        TOKEN_VERIFY=$(curl -s -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json")

        if echo "$TOKEN_VERIFY" | jq -e '.success' > /dev/null; then
          echo "✓ API Token is valid"
        else
          echo "✗ API Token verification failed"
          echo "$TOKEN_VERIFY" | jq .
          exit 1
        fi

        # Extract Account ID from token if not provided
        if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
          echo ""
          echo "Step 2: Getting Account ID..."
          ACCOUNT_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" | jq -r '.result[0].id // empty')

          if [ -z "$ACCOUNT_ID" ]; then
            echo "✗ Failed to get Account ID from API"
            exit 1
          fi
          echo "✓ Account ID: ${ACCOUNT_ID:0:20}..."
        else
          ACCOUNT_ID="$CLOUDFLARE_API_TOKEN"
          echo "Step 2: Using provided Account ID"
        fi

        # Check for existing tunnel
        echo ""
        echo "Step 3: Checking for existing tunnel..."
        TUNNEL_NAME="headscale-k8s-tunnel"

        TUNNELS_RESPONSE=$(curl -s -X GET \
          "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/cfd_tunnel" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json")

        EXISTING_TUNNEL=$(echo "$TUNNELS_RESPONSE" | jq -r ".result[] | select(.name == \"${TUNNEL_NAME}\") | .id" | head -1)

        if [ -n "$EXISTING_TUNNEL" ]; then
          echo "✓ Found existing tunnel: ${TUNNEL_NAME}"
          echo "  Tunnel ID: ${EXISTING_TUNNEL}"
          TUNNEL_ID="$EXISTING_TUNNEL"

          # Get tunnel token
          echo "Fetching tunnel token..."
          TUNNEL_TOKEN=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/cfd_tunnel/${TUNNEL_ID}/token" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" | jq -r '.result // empty')

          if [ -z "$TUNNEL_TOKEN" ]; then
            echo "⚠ Could not retrieve tunnel token, will create new tunnel..."
            EXISTING_TUNNEL=""
          fi
        fi

        # Create new tunnel if needed
        if [ -z "$EXISTING_TUNNEL" ]; then
          echo ""
          echo "Step 4: Creating new tunnel..."

          CREATE_RESPONSE=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/cfd_tunnel" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data "{\"name\":\"${TUNNEL_NAME}\",\"config_src\":\"cloudflare\"}")

          TUNNEL_ID=$(echo "$CREATE_RESPONSE" | jq -r '.result.id // empty')

          if [ -z "$TUNNEL_ID" ]; then
            echo "✗ Failed to create tunnel"
            echo "$CREATE_RESPONSE" | jq .
            exit 1
          fi

          echo "✓ Created tunnel: ${TUNNEL_NAME}"
          echo "  Tunnel ID: ${TUNNEL_ID}"

          # Get tunnel token
          TUNNEL_TOKEN=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/cfd_tunnel/${TUNNEL_ID}/token" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" | jq -r '.result // empty')
        fi

        if [ -z "$TUNNEL_TOKEN" ]; then
          echo "✗ Failed to get tunnel token"
          exit 1
        fi

        # Create config.yaml
        echo ""
        echo "Step 5: Creating tunnel configuration..."
        cat > /tmp/config.yaml <<EOF
        tunnel: ${TUNNEL_ID}
        credentials-file: /etc/cloudflared/credentials.json
        protocol: http2

        ingress:
          - hostname: ${HEADSCALE_DOMAIN}
            service: http://headscale-service.headscale.svc.cluster.local:8080
            originRequest:
              noTLSVerify: true
              connectTimeout: 30s
              http2Origin: true
          - service: http_status:404
        EOF

        echo "✓ Configuration file created"

        # Update ConfigMap
        echo ""
        echo "Step 6: Updating Kubernetes ConfigMap..."
        kubectl create configmap cloudflared-config \
          --from-file=config.yaml=/tmp/config.yaml \
          --namespace=headscale \
          --dry-run=client -o yaml | kubectl apply -f -

        echo "✓ ConfigMap updated"

        # Create Secret with tunnel token
        echo ""
        echo "Step 7: Creating Kubernetes Secret with tunnel token..."
        kubectl create secret generic cloudflared-token \
          --from-literal=token="${TUNNEL_TOKEN}" \
          --namespace=headscale \
          --dry-run=client -o yaml | kubectl apply -f -

        echo "✓ Secret created"

        echo ""
        echo "==== Setup Complete ===="
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Account ID:     ${ACCOUNT_ID:0:20}..."
        echo "Tunnel ID:      ${TUNNEL_ID}"
        echo "Tunnel Name:    ${TUNNEL_NAME}"
        echo "Hostname:       ${HEADSCALE_DOMAIN}"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        echo "Next steps:"
        echo "1. Set up DNS CNAME record in Cloudflare:"
        echo "   Name: ${HEADSCALE_DOMAIN}"
        echo "   Type: CNAME"
        echo "   Content: ${TUNNEL_ID}.cfargotunnel.com"
        echo "   Proxy: Proxied (orange cloud)"
        echo ""
        echo "2. Check tunnel status:"
        echo "   kubectl logs -f deploy/cloudflared -n headscale"
        echo ""

---
# Job to setup Cloudflare Tunnel
apiVersion: batch/v1
kind: Job
metadata:
    name: cloudflared-setup
    namespace: headscale
spec:
    ttlSecondsAfterFinished: 3600
    backoffLimit: 3
    template:
        metadata:
            labels:
                app: cloudflared-setup
        spec:
            restartPolicy: OnFailure
            serviceAccountName: cloudflared-setup
            containers:
                - name: setup
                  image: alpine:latest
                  command:
                      - /bin/sh
                      - /scripts/setup-tunnel.sh
                  env:
                      - name: CLOUDFLARE_API_TOKEN
                        valueFrom:
                            secretKeyRef:
                                name: cloudflare-api-token
                                key: token
                      - name: CLOUDFLARE_ACCOUNT_ID
                        value: "CLOUDFLARE_ACCOUNT_ID_PLACEHOLDER"
                      - name: HEADSCALE_DOMAIN
                        value: "HEADSCALE_DOMAIN_PLACEHOLDER"
                  volumeMounts:
                      - name: scripts
                        mountPath: /scripts
            volumes:
                - name: scripts
                  configMap:
                      name: cloudflared-setup-script
                      defaultMode: 0755

---
# ConfigMap for Cloudflared configuration (will be created/updated by job)
apiVersion: v1
kind: ConfigMap
metadata:
    name: cloudflared-config
    namespace: headscale
data:
    config.yaml: |
        # This will be updated by the setup job
        tunnel: ""
        credentials-file: /etc/cloudflared/credentials.json
        protocol: http2

        ingress:
          - service: http_status:404

---
# Deployment for Cloudflared
apiVersion: apps/v1
kind: Deployment
metadata:
    name: cloudflared
    namespace: headscale
    labels:
        app: cloudflared
spec:
    replicas: 2
    selector:
        matchLabels:
            app: cloudflared
    template:
        metadata:
            labels:
                app: cloudflared
        spec:
            containers:
                - name: cloudflared
                  image: cloudflare/cloudflared:latest
                  imagePullPolicy: IfNotPresent
                  command:
                      - cloudflared
                      - tunnel
                      - --config
                      - /etc/cloudflared/config.yaml
                      - --token
                      - $(CLOUDFLARED_TOKEN)
                      - --no-autoupdate
                      - run
                  env:
                      - name: CLOUDFLARED_TOKEN
                        valueFrom:
                            secretKeyRef:
                                name: cloudflared-token
                                key: token
                      - name: TZ
                        value: "TZ_PLACEHOLDER"
                  ports:
                      - name: metrics
                        containerPort: 2000
                        protocol: TCP
                  volumeMounts:
                      - name: config
                        mountPath: /etc/cloudflared/config.yaml
                        subPath: config.yaml
                        readOnly: true
                  resources:
                      requests:
                          memory: "64Mi"
                          cpu: "50m"
                      limits:
                          memory: "128Mi"
                          cpu: "200m"
                  livenessProbe:
                      httpGet:
                          path: /ready
                          port: 2000
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      failureThreshold: 3
                      timeoutSeconds: 5
            volumes:
                - name: config
                  configMap:
                      name: cloudflared-config
            securityContext:
                runAsUser: 65532
                runAsNonRoot: true
                fsGroup: 65532
